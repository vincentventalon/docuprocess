# ShipFast TypeScript SaaS Boilerplate - Cursor Rules

## Project Overview
This is a Next.js 15+ TypeScript SaaS boilerplate with Stripe payments, Supabase authentication, and modern UI components using DaisyUI/TailwindCSS v4. It includes a **FastAPI Python backend** for PDF generation and template rendering.

## Tech Stack & Dependencies

### Frontend (Next.js)
- **Framework**: Next.js 15+ with App Router
- **Language**: TypeScript 5.9+
- **Database**: Supabase (PostgreSQL) with Row Level Security
- **Authentication**: Supabase Auth with Google OAuth and Email providers
- **Payments**: Stripe integration with webhooks
- **Styling**: TailwindCSS 4.1+ with DaisyUI 5.0+ (CSS-first configuration)
- **Email**: Resend for transactional emails
- **UI Components**:
  - shadcn/ui (Radix UI primitives with Tailwind styling)
  - Headless UI, React Hot Toast, React Tooltip
  - Lucide React for icons
- **Blog**: MDX support for blog content

### Backend (FastAPI Python)
- **Framework**: FastAPI with Uvicorn ASGI server
- **Language**: Python 3.11+
- **PDF Generation**: WeasyPrint for HTML to PDF conversion
- **Template Engine**: Custom Jinja2-based template rendering
- **Database**: Supabase (shared with frontend)
- **Authentication**: JWT tokens + API key authentication
- **Testing**: pytest with async support
- **Code Quality**: black, ruff, mypy

## Code Style & Conventions

### TypeScript (Frontend)
- Use strict TypeScript with proper typing
- Prefer interface over type for object definitions
- Use proper generic types for reusable components
- Import types using `import type { }` when possible
- Use Zod for runtime validation when needed
- Always handle Promise types correctly (especially for Next.js 15 async APIs)

### Python (Backend)
- Use Python 3.11+ type hints for all functions
- Follow PEP 8 style guide (enforced by black and ruff)
- Use async/await for all I/O operations
- Use Pydantic models for all request/response validation
- Line length: 100 characters (black/ruff configured)
- Prefer explicit over implicit
- Use descriptive variable and function names

### File Naming & Structure

**Frontend:**
- Use kebab-case for file names: `button-checkout.tsx`
- Use PascalCase for component names: `ButtonCheckout`
- Use camelCase for functions and variables
- API routes: `/app/api/[feature]/route.ts`
- Components: `/components/ComponentName.tsx`
- Pages: `/app/[route]/page.tsx`
- Types: `/types/[feature].ts`
- Utils/Libs: `/libs/[utility].ts`

**Backend:**
- Use snake_case for file names: `template_service.py`
- Use PascalCase for class names: `TemplateService`
- Use snake_case for functions and variables
- API routers: `/backend/app/routers/[feature].py`
- Services: `/backend/app/services/[feature]_service.py`
- Models: `/backend/app/models/[feature].py`
- Tests: `/backend/tests/test_[feature].py`

### Component Architecture
- Use functional components with hooks
- Prefer server components by default, use "use client" only when necessary
- Export default for main component, named exports for utilities
- Keep components focused and single-responsibility
- Use proper TypeScript interfaces for props

### shadcn/ui Component Patterns
- **Location**: `/components/ui/` - 60+ accessible components built on Radix UI
- **Import**: `import { Button } from "@/components/ui/button"`
- **Styling**: Use `cn()` from `@/lib/utils` for conditional classes
- **Customization**: Edit component files directly or pass className prop
- **Note**: Most require "use client" directive

### Import Order
1. React and Next.js imports
2. Third-party libraries
3. Internal components (components/)
4. Internal utilities (libs/)
5. Internal types (types/)
6. Config and constants
7. Relative imports

### API Routes (Next.js 15)
- Use proper HTTP methods (GET, POST, PUT, DELETE)
- Always validate request bodies
- Use proper error handling with try-catch
- Return consistent JSON responses with proper status codes
- Use `await createClient()` for Supabase server client (async in Next.js 15)
- Use `await headers()` and `await cookies()` for Next.js 15 compatibility
- Handle webhook signature verification properly for Stripe

### Database & Supabase
- Use Supabase client for database operations
- Always use `await createClient()` for server-side Supabase client
- Use proper error handling for database operations
- Implement Row Level Security (RLS) policies
- Use proper session handling with Supabase Auth

### Authentication (Supabase)
- Use Supabase Auth patterns
- Check authentication in API routes when needed
- Use proper session handling
- Implement proper user creation and updates
- Handle OAuth callbacks correctly

### Stripe Integration
- Use proper webhook signature verification
- Handle all relevant Stripe events properly
- Update user access based on payment status
- Use proper error handling for Stripe operations
- Store customer and subscription data in Supabase

## Next.js 15 Specific Patterns

### Async APIs
- `headers()` and `cookies()` now return Promises - always use `await`
- `params` in dynamic routes are now Promises - use `await params`
- Server components can be async by default

### Dynamic Routes
```typescript
// Correct Next.js 15 pattern
export default async function Page({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { id } = await params;
  // ... rest of component
}

export async function generateMetadata({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { id } = await params;
  // ... rest of function
}
```

### Server Components
- Use server components by default
- Only add "use client" when absolutely necessary
- Handle async operations properly in server components

## Tailwind CSS v4 Specific Patterns

### Configuration
- Use CSS-first configuration in `app/globals.css` with `@theme` directive
- No more `tailwind.config.js` file - all customization in CSS
- Use `@import "tailwindcss"` instead of `@tailwind` directives
- PostCSS uses `@tailwindcss/postcss` plugin

### Theme Variables
```css
@theme {
  --color-brand-500: #570df8;
  --spacing-custom: 2.5rem;
  --font-display: "Inter", sans-serif;
}
```

### Custom Components
```css
@utility btn-custom {
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  background-color: var(--color-brand-500);
}
```

### Component Patterns
- **shadcn/ui**: Use for forms, dialogs, tables, complex UI (`Button`, `Card`, `Dialog`, `Form`, `Input`, `Select`)
- **DaisyUI**: Use for layout and marketing components (`btn`, `card`, `hero`, etc.)
- Implement responsive design with Tailwind breakpoints
- Use proper semantic HTML and accessibility attributes

## Supabase Patterns

### Server Client
```typescript
import { createClient } from "@/libs/supabase/server";

export default async function Page() {
  const supabase = await createClient(); // Note: await required in Next.js 15
  const { data: { user } } = await supabase.auth.getUser();
  // ...
}
```

### Client Component
```typescript
"use client";
import { createClient } from "@/libs/supabase/client";

export default function ClientComponent() {
  const supabase = createClient(); // No await needed for client
  // ...
}
```

### Authentication Checks
```typescript
// Server component
const supabase = await createClient();
const { data: { user } } = await supabase.auth.getUser();

if (!user) {
  redirect("/signin");
}
```

## Backend Architecture (FastAPI)

### Service Layer Pattern
- **Routers**: Thin handlers for HTTP requests/responses only
- **Services**: Business logic, orchestration, and operations
- **Models**: Pydantic models for validation
- **Dependencies**: Reusable FastAPI dependencies (auth, etc.)
- **Core**: Shared utilities and configurations

### Router Pattern (Thin Controllers)
```python
# Routers should be thin and delegate to services
@router.post("/render")
async def render_template(
    request: TemplateRenderRequest,
    user: AuthenticatedUser = Depends(get_current_user)
):
    # 1. Authorization check
    if not await template_service.verify_ownership(request.template_id, user.user_id):
        raise HTTPException(status_code=403)

    # 2. Business logic in service
    result = await template_service.render(request)

    # 3. Return response
    return result
```

### Service Pattern
```python
# Services contain business logic
class TemplateService:
    async def verify_ownership(self, template_id: str, user_id: str) -> bool:
        # Database queries and business logic here
        pass

    async def render(self, request: TemplateRenderRequest) -> str:
        # Complex rendering logic here
        pass

# Singleton instance
template_service = TemplateService()
```

### Authentication Pattern
- Support both JWT tokens (frontend) and API keys (direct API)
- Use FastAPI's `Depends()` for dependency injection
- Return `AuthenticatedUser` with user_id, email, and auth_method

### Error Handling
- Use `HTTPException` with proper status codes
- 400: Bad Request (validation errors)
- 401: Unauthorized (invalid auth)
- 402: Payment Required (insufficient credits)
- 403: Forbidden (not authorized)
- 404: Not Found
- 500: Internal Server Error

### Testing Pattern
- Use pytest with async support
- Mock external services (Supabase, storage)
- Test routers and services separately
- Use fixtures for common test data

## Environment Variables

### Frontend & Backend (Shared .env.local)
- `NEXT_PUBLIC_SUPABASE_URL` - Supabase project URL
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` - Supabase anon key
- `SUPABASE_SERVICE_ROLE_KEY` - Server-side operations (backend uses this)
- `STRIPE_SECRET_KEY` and `STRIPE_WEBHOOK_SECRET` - Payments
- `RESEND_API_KEY` - Emails

### Backend-Specific
- `API_KEY` - For direct API access authentication
- `ALLOWED_ORIGINS` - CORS configuration (comma-separated)
- `MAX_PDF_SIZE_MB` - PDF size limit
- `DEFAULT_PAGE_SIZE` - Default page size for PDFs

## Error Handling
- Use try-catch blocks in API routes
- Log errors with descriptive messages
- Return proper HTTP status codes
- Use toast notifications for user-facing errors
- Handle loading states in components
- Handle Supabase auth errors properly

## Performance
- Use Next.js Image component for images with `remotePatterns`
- Implement proper lazy loading
- Use proper caching strategies
- Optimize bundle size with proper imports
- Use server components when possible

## Security
- Validate all inputs with Zod or similar
- Use Supabase RLS for data security
- Verify webhook signatures (Stripe)
- Sanitize user data
- Use proper authentication checks
- Never expose service role keys on client

## Testing
- Write unit tests for utility functions
- Test API routes with proper mocking
- Test components with React Testing Library
- Use proper TypeScript types in tests

## CLI Tools

### Vercel CLI
Use Vercel CLI to manage deployments and debug issues:

```bash
# View deployment logs
vercel logs [deployment-url]
vercel logs --prod

# Inspect deployment
vercel inspect [deployment-url]

# Check deployment status
vercel ls

# Pull environment variables
vercel env pull

# Deploy
vercel --prod
```

### Supabase CLI
Use Supabase CLI for database management and local development:

```bash
# Database migrations
supabase migration new migration_name
supabase db push
supabase db pull

# Generate TypeScript types
supabase gen types typescript --project-ref your-ref > types/supabase.ts

# Local development
supabase start  # Start local instance
supabase stop   # Stop local instance

# Run SQL queries
supabase db query "SELECT * FROM profiles"

# Link to remote project
supabase link --project-ref your-project-ref
```

## Commit Messages
Use Conventional Commits format:
- `feat:` for new features
- `fix:` for bug fixes
- `docs:` for documentation
- `style:` for formatting changes
- `refactor:` for code refactoring
- `test:` for adding tests
- `chore:` for maintenance tasks

## Do Not

### Frontend (Next.js/TypeScript)
- Don't use `any` type unless absolutely necessary
- Don't bypass TypeScript strict mode
- Don't forget to handle loading and error states
- Don't hardcode configuration values
- Don't forget to validate user inputs
- Don't skip error handling in async operations
- Don't use inline styles, prefer TailwindCSS classes
- Don't create components without proper TypeScript interfaces
- Don't forget to use `await` with Next.js 15 async APIs
- Don't skip webhook signature verification for Stripe
- Don't expose sensitive environment variables on client
- Don't forget to implement RLS policies in Supabase

### Backend (Python/FastAPI)
- Don't put business logic in routers - use services
- Don't use sync functions for I/O operations - use async/await
- Don't skip input validation - always use Pydantic models
- Don't hardcode API keys or secrets - use environment variables
- Don't forget type hints on functions
- Don't skip error handling in async operations
- Don't expose internal error details in API responses
- Don't skip authentication checks in protected routes
- Don't query database directly in routers - use services
- Don't forget to test with mocked dependencies
- Don't use synchronous Supabase client calls

## Backend File Structure

```
backend/
├── app/
│   ├── core/              # Core utilities and configurations
│   │   ├── config.py      # Application settings
│   │   └── template_engine.py  # Custom template rendering
│   ├── dependencies/      # FastAPI dependencies
│   │   └── auth.py        # JWT & API key authentication
│   ├── models/            # Pydantic models
│   │   └── template.py    # Request/response schemas
│   ├── routers/           # API endpoints (thin handlers)
│   │   ├── pdf.py         # PDF generation endpoints
│   │   └── template.py    # Template rendering endpoints
│   ├── services/          # Business logic layer
│   │   ├── credit_service.py     # Credit management
│   │   └── template_service.py   # Template operations
│   ├── storage.py         # Supabase storage integration
│   └── main.py            # FastAPI application
└── tests/                 # Test suite
```

## Working with Frontend + Backend

### Communication Pattern
1. **Frontend** (Next.js) calls backend API routes
2. **Backend API routes** (Next.js) call Python backend
3. **Python backend** processes and returns data

Example:
```typescript
// Frontend component calls Next.js API
fetch('/api/generate-pdf', { ... })

// Next.js API route proxies to Python backend
fetch('http://localhost:8000/api/template/render', {
  headers: { 'x-api-key': process.env.API_KEY }
})
```

### Development Workflow
- Run frontend: `npm run dev` (port 3000)
- Run backend: `cd backend && uv run uvicorn app.main:app --reload` (port 8000)
- Both can run simultaneously in different terminals

## Migration Notes (Next.js 14 → 15)
- Update `params` in dynamic routes to handle Promises
- Update `headers()` and `cookies()` calls to use `await`
- Update Supabase server client calls to use `await createClient()`
- Update image domains to use `remotePatterns` instead of `domains`
- Update Tailwind config from JS to CSS-first approach
- Update DaisyUI to v5+ and handle theme changes 